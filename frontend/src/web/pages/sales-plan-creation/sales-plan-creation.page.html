<ion-content class="ion-padding">
  <ion-grid class="full-height">
    <ion-row class="ion-justify-content-center ion-align-items-center full-height">
      <ion-col size="12" size-lg="10" size-xl="10">
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ 'salesPlan.title' | translate }}</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col size="12" size-md="4">
                  <form [formGroup]="salesPlanForm" (ngSubmit)="onSubmit()">
                    <ion-item [class.ion-invalid]="vendorControl?.invalid && vendorControl?.touched">
                      <ion-label position="stacked"> {{ 'salesPlan.assignedVendor' | translate}} </ion-label>
                      <ion-select
                        formControlName="vendor_id"
                        [placeholder]="'salesPlan.assignedVendorPlaceholder' | translate"
                      >
                        @for (vendor of vendors; track vendor.vendor_id) {
                        <ion-select-option [value]="vendor.vendor_id">{{ vendor.name }}</ion-select-option>
                        }
                      </ion-select>
                    </ion-item>
                    @if (vendorControl?.invalid && vendorControl?.touched) {
                    <div class="error-message">
                      @if (vendorControl?.errors?.['required']) {
                      <small>{{ 'salesPlan.vendorRequired' | translate }}</small>
                      }
                    </div>
                    }

                    <ion-item [class.ion-invalid]="regionControl?.invalid && regionControl?.touched">
                      <ion-label position="stacked"> {{ 'salesPlan.region' | translate }} </ion-label>
                      <ion-select formControlName="region" [placeholder]="'salesPlan.regionPlaceholder' | translate">
                        @for (region of regions; track region.value) {
                        <ion-select-option [value]="region.value">{{ region.label }}</ion-select-option>
                        }
                      </ion-select>
                    </ion-item>
                    @if (regionControl?.invalid && regionControl?.touched) {
                    <div class="error-message">
                      @if (regionControl?.errors?.['required']) {
                      <small>{{ 'salesPlan.regionRequired' | translate }}</small>
                      }
                    </div>
                    }

                    <ion-item [class.ion-invalid]="periodControl?.invalid && periodControl?.touched">
                      <ion-label position="stacked"> {{ 'salesPlan.period' | translate }} </ion-label>
                      <ion-select formControlName="period" [placeholder]="'salesPlan.periodPlaceholder' | translate">
                        @for (period of periods; track period.value) {
                        <ion-select-option [value]="period.value">{{ period.label }}</ion-select-option>
                        }
                      </ion-select>
                    </ion-item>
                    @if (periodControl?.invalid && periodControl?.touched) {
                    <div class="error-message">
                      @if (periodControl?.errors?.['required']) {
                      <small>{{ 'salesPlan.periodRequired' | translate }}</small>
                      }
                    </div>
                    }

                    <section class="products-section">
                      @if (selectedProducts.length > 0) { @for (product of selectedProducts; track product.id) {
                      <div class="product-card">
                        <div class="product-header">
                          <span class="product-name">{{ 'salesPlan.product' | translate }} {{ product.name }}</span>
                          <ion-button
                            onkeypress
                            fill="clear"
                            color="danger"
                            size="small"
                            (click)="removeProduct(product.id)"
                          >
                            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                          </ion-button>
                        </div>
                        <div class="product-details">
                          <small
                            ><strong>{{ 'salesPlan.goal' | translate }}</strong> {{ product.target_units }} {{
                            'salesPlan.units' | translate }}</small
                          >
                          <small><strong>{{ 'salesPlan.value' | translate }}</strong> {{ product.target_value }}</small>
                        </div>
                      </div>
                      } }
                    </section>

                    <ion-button
                      onkeypress
                      expand="block"
                      color="secondary"
                      type="button"
                      (click)="openAddProductModal()"
                      class="add-product-button"
                    >
                      <ion-icon slot="start" name="add"></ion-icon>
                      {{ 'salesPlan.addProductButton' | translate }}
                    </ion-button>

                    <ion-grid class="button-group">
                      <ion-row>
                        <ion-col size="12">
                          <ion-button
                            expand="block"
                            color="primary"
                            type="submit"
                            [disabled]="salesPlanForm.invalid || selectedProducts.length === 0"
                          >
                            {{ 'salesPlan.reviewAndCreate' | translate }}
                          </ion-button>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </form>
                </ion-col>

                <ion-col size="12" size-md="8">
                  <div class="table-container">
                    <table class="sales-table">
                      <thead>
                        <tr>
                          <th>{{ 'salesPlan.table.seller' | translate }}</th>
                          <th>{{ 'salesPlan.table.email' | translate }}</th>
                          <th>{{ 'salesPlan.table.institutions' | translate }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (vendor of vendors; track vendor.vendor_id) {
                        <tr>
                          <td>{{ vendor.name }}</td>
                          <td>{{ vendor.email }}</td>
                          <td>{{ vendor.institutions.join(', ') || 'N/A' }}</td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
